<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>InSight AI ‚Äì Chatbox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="api.js"></script>
</head>
<body>
<div class="app" id="app-root">
    <!-- Sidebar conversation list -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Cu·ªôc h·ªôi tho·∫°i</div>
            <button class="new-conv-btn" id="new-conv-btn">New chat
            </button>
        </div>
        <div id="conv-list" class="conv-list">
            <!-- JS s·∫Ω render danh s√°ch conversation v√†o ƒë√¢y -->
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-footer-text">
                L·ªãch s·ª≠ ƒë∆∞·ª£c l∆∞u theo t·ª´ng cu·ªôc h·ªôi tho·∫°i. B·∫•m v√†o ƒë·ªÉ xem l·∫°i.
            </div>
        </div>
    </aside>

    <main class="main">
        <header class="main-header">
            <div class="title-block">
                <img src="images/logofakenews.jpg" class="avatar-img" alt="Insight AI Logo" width="40" height="40">

                <div>
                    <div class="app-name">Fake News Detect AI</div>
                    <div class="app-desc">Chatbox ph√¢n t√≠ch n·ªôi dung & h·ªó tr·ª£ b·∫°n hi·ªÉu th√¥ng tin s√¢u h∆°n.</div>
                </div>
            </div>
            <div class="header-actions">
                <!-- Ph√≥ng to / thu nh·ªè (·∫©n/hi·ªán sidebar) -->
                <button id="toggle-layout" class="header-icon-btn" title="Ph√≥ng to / thu nh·ªè chat">
                    ‚§¢
                </button>
            </div>
        </header>

        <section class="chat-area">
            <div id="messages" class="messages"></div>
            <div id="status" class="status-bar"></div>

            <div class="input-area">
                <div class="input-row">
                    <div class="input-box">
                        <textarea id="message-input" rows="1" aria-label="N·ªôi dung c·∫ßn ki·ªÉm tra"
                                  placeholder="D√°n ƒëo·∫°n tin ho·∫∑c b√†i b√°o ti·∫øng Vi·ªát, link, file ƒë·ªÉ ki·ªÉm tra Fake/Real... "></textarea>
                        <div class="input-actions">
                            <input type="file" id="file-input" accept=".txt,.doc,.docx" style="display:none">
                            <button type="button" class="icon-btn" id="attach-btn" title="T·∫£i l√™n .txt, .doc, .docx">
                                üìé
                            </button>
                        </div>
                    </div>
                    <button class="send-btn" id="send-btn">Ph√¢n t√≠ch</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Modal x√°c nh·∫≠n x√≥a -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-title">X√≥a cu·ªôc h·ªôi tho·∫°i?</div>
            <div class="modal-text">
                B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ƒëo·∫°n chat n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
            </div>
            <div class="modal-actions">
                <button id="confirm-cancel" class="btn-secondary">H·ªßy</button>
                <button id="confirm-ok" class="btn-danger">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>
</div>

<script>
    // =========================
    // L·∫§Y C√ÅC PH·∫¶N T·ª¨ DOM
    // =========================
    const appRoot      = document.getElementById('app-root');
    const messagesDiv  = document.getElementById('messages');
    const statusDiv    = document.getElementById('status');
    const messageInput = document.getElementById('message-input');
    const sendBtn      = document.getElementById('send-btn');
    const fileInput    = document.getElementById('file-input');
    const attachBtn    = document.getElementById('attach-btn');
    const convListEl   = document.getElementById('conv-list');
    const newConvBtn   = document.getElementById('new-conv-btn');
    const logoutBtn    = document.getElementById('logout-btn');
    const toastEl      = document.getElementById('toast');
    const toggleLayoutBtn = document.getElementById('toggle-layout');

    const confirmModal   = document.getElementById('confirm-modal');
    const confirmCancel  = document.getElementById('confirm-cancel');
    const confirmOk      = document.getElementById('confirm-ok');
    let pendingDeleteId  = null;

    // =========================
    // STATE CHO SIDEBAR
    // =========================
    // ·ªû ƒë√¢y t·∫°m g·ªçi m·ªói l·∫ßn ph√¢n t√≠ch (1 HistoryItemResponse) l√† 1 "conversation"
    let conversations = [];      // m·∫£ng c√°c item l·∫•y t·ª´ /api/analyze/history ƒë√£ map l·∫°i
    let conversationId = null;   // id ƒëang ƒë∆∞·ª£c ch·ªçn

    // =========================
    // TOAST N·ªîI
    // =========================
    function showToast(message, type = 'error') {
        toastEl.textContent = message;
        toastEl.classList.remove('error', 'success');
        toastEl.classList.add(type === 'success' ? 'success' : 'error');
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 2500);
    }

    // =========================
    // CHAT MESSAGE: TH√äM / X√ìA
    // =========================
    function addMessage(sender, text, extra = {}) {
        const row = document.createElement('div');
        const isUser = sender.toUpperCase() === 'USER';
        row.classList.add('message-row', isUser ? 'user' : 'model');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');
        bubble.textContent = text;
        row.appendChild(bubble);

        if (!isUser && (extra.verdict || extra.score)) {
            const extraDiv = document.createElement('div');
            extraDiv.className = 'model-extra';

            if (extra.verdict) {
                const badge = document.createElement('span');
                badge.classList.add('badge');
                if (extra.verdict === 'FAKE') badge.classList.add('badge-fake');
                else if (extra.verdict === 'REAL') badge.classList.add('badge-real');
                badge.textContent = extra.verdict === 'FAKE' ? 'TIN GI·∫¢' : 'TIN TH·∫¨T';
                extraDiv.appendChild(badge);
            }

            if (typeof extra.score === 'number') {
                const s = document.createElement('span');
                s.textContent = `ƒê·ªô tin c·∫≠y: ${(extra.score * 100).toFixed(1)}%`;
                extraDiv.appendChild(s);
            }

            row.appendChild(extraDiv);
        }

        messagesDiv.appendChild(row);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        messagesDiv.innerHTML = '';
    }

    // =========================
    // MAP T·ª™ HistoryItemResponse ‚Üí "conversation item"
    // =========================
    function buildConversationFromHistoryItem(item) {
        // item: HistoryItemResponse t·ª´ /api/analyze/history
        const d = item.createdAt ? new Date(item.createdAt) : null;
        const ts = d && !isNaN(d.getTime()) ? d.getTime() : 0;
        const timeLabel = d && !isNaN(d.getTime())
            ? d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
            : '';

        let title = item.title;
        if (!title) {
            if (item.inputType === 'URL') {
                title = item.url || 'L·∫ßn ph√¢n t√≠ch URL';
            } else if (item.inputType === 'FILE') {
                title = item.fileName || 'L·∫ßn ph√¢n t√≠ch File';
            } else {
                title = 'L·∫ßn ph√¢n t√≠ch vƒÉn b·∫£n';
            }
        }

        return {
            id: item.itemId,
            title,
            lastVerdict: item.label,    // FAKE / REAL / ...
            updatedAt: timeLabel,
            updatedAtTs: ts,
            item       // gi·ªØ nguy√™n object g·ªëc ƒë·ªÉ d√πng l·∫°i khi click
        };
    }

    // =========================
    // RENDER SIDEBAR
    // =========================
    function renderConversationList() {
        convListEl.innerHTML = '';

        conversations
            .sort((a, b) => (b.updatedAtTs || 0) - (a.updatedAtTs || 0))
            .forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conv-item';
                item.dataset.id = conv.id;
                if (String(conv.id) === String(conversationId)) {
                    item.classList.add('active');
                }

                const left = document.createElement('div');
                left.className = 'conv-left';

                const title = document.createElement('div');
                title.className = 'conv-title';
                title.textContent = conv.title;

                const meta = document.createElement('div');
                meta.className = 'conv-meta';

                if (conv.lastVerdict) {
                    const badge = document.createElement('span');
                    badge.classList.add('badge');
                    if (conv.lastVerdict === 'FAKE') badge.classList.add('badge-fake');
                    else if (conv.lastVerdict === 'REAL') badge.classList.add('badge-real');
                    badge.textContent = conv.lastVerdict === 'FAKE' ? 'TIN GI·∫¢' : 'TIN TH·∫¨T';
                    meta.appendChild(badge);
                }

                const time = document.createElement('span');
                time.textContent = conv.updatedAt || '';
                meta.appendChild(time);

                left.appendChild(title);
                left.appendChild(meta);

                const delBtn = document.createElement('button');
                delBtn.className = 'conv-delete';
                delBtn.textContent = 'X√≥a';
                delBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDeleteModal(conv.id);
                });

                item.appendChild(left);
                item.appendChild(delBtn);
                item.addEventListener('click', () => selectConversation(conv.id));

                convListEl.appendChild(item);
            });
    }

    // =========================
    // LOAD HISTORY T·ª™ /api/analyze/history
    // (d√πng h√†m getHistoryApi() trong api.js)
    // =========================
    async function loadConversations() {
        try {
            statusDiv.textContent = 'ƒêang t·∫£i l·ªãch s·ª≠...';
            const data = await getHistoryApi();   // h√†m ƒë√£ c√≥ trong api.js
            conversations = Array.isArray(data)
                ? data.map(buildConversationFromHistoryItem)
                : [];
            renderConversationList();
            statusDiv.textContent = '';
        } catch (e) {
            console.error(e);
            statusDiv.textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠.';
            showToast('Kh√¥ng t·∫£i ƒë∆∞·ª£c l·ªãch s·ª≠: ' + e.message, 'error');
        }
    }

    // =========================
    // KHI CLICK 1 ITEM TRONG SIDEBAR
    // ‚Üí LOAD L·∫†I 2 MESSAGE: USER + MODEL CHO L·∫¶N PH√ÇN T√çCH ƒê√ì
    // =========================
    function selectConversation(id) {
        const conv = conversations.find(c => String(c.id) === String(id));
        if (!conv) return;

        conversationId = conv.id;
        clearMessages();

        const item = conv.item;

        let userText;
        if (item.inputType === 'URL') {
            userText = `L·∫ßn tr∆∞·ªõc b·∫°n ƒë√£ ki·ªÉm tra link: ${item.url || '(kh√¥ng c√≥ URL)'}`;
        } else if (item.inputType === 'FILE') {
            userText = `L·∫ßn tr∆∞·ªõc b·∫°n ƒë√£ ki·ªÉm tra file: ${item.fileName || '(kh√¥ng c√≥ t√™n file)'}`;
        } else {
            userText = item.title || 'L·∫ßn tr∆∞·ªõc b·∫°n ƒë√£ ki·ªÉm tra m·ªôt ƒëo·∫°n vƒÉn b·∫£n.';
        }

        addMessage('USER', userText);

        const verdict = item.label; // enum FAKE / REAL / ...
        let score = 0;
        if (typeof item.probReal === 'number') score = item.probReal;
        else if (typeof item.probFake === 'number') score = 1 - item.probFake;

        const msgText = verdict === 'FAKE'
            ? 'K·∫øt qu·∫£ l·∫ßn ƒë√≥: TIN GI·∫¢. H√£y c·∫©n th·∫≠n khi chia s·∫ª n·ªôi dung n√†y.'
            : verdict === 'REAL'
                ? 'K·∫øt qu·∫£ l·∫ßn ƒë√≥: TIN TH·∫¨T / ƒê√ÅNG TIN C·∫¨Y.'
                : `K·∫øt qu·∫£ l·∫ßn ƒë√≥: ${verdict || 'Kh√¥ng x√°c ƒë·ªãnh'}`;

        addMessage('MODEL', msgText, { verdict, score });
        statusDiv.textContent = '';
    }

    // =========================
    // N√öT "NEW CHAT" ‚Üí X√ìA KHUNG CHAT, KH√îNG ƒê·ª§NG DB
    // =========================
    newConvBtn.addEventListener('click', () => {
        conversationId = null;
        clearMessages();
        statusDiv.textContent = 'ƒê√£ t·∫°o cu·ªôc tr√≤ chuy·ªán m·ªõi. H√£y nh·∫≠p vƒÉn b·∫£n ƒë·ªÉ ph√¢n t√≠ch.';
        renderConversationList();
    });

    // =========================
    // G·ª¨I TEXT ‚Üí G·ªåI analyzeTextApi()
    // =========================
    async function sendText() {
        const text = messageInput.value.trim();
        if (!text) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt c·∫ßn ki·ªÉm tra.', 'error');
            return;
        }

        addMessage('USER', text);
        messageInput.value = '';
        autoResizeTextarea();

        sendBtn.disabled = true;
        statusDiv.textContent = 'ƒêang ph√¢n t√≠ch n·ªôi dung...';

        try {
            let data;
            const urlPattern = /^(https?:\/\/[^\s]+)$/i;
            const isUrl = urlPattern.test(text);

            if (isUrl) {
                // URL ‚Üí g·ªçi analyzeUrlApi
                const url = text;
                const title = null; // c√≥ th·ªÉ cho nh·∫≠p ri√™ng sau
                data = await analyzeUrlApi(url, title);
            } else {
                // TEXT ‚Üí g·ªçi analyzeTextApi
                const title = text.substring(0, 80);
                data = await analyzeTextApi(title, text);
            }

            const verdict  = data.label; // FAKE / REAL / UNKNOWN
            const probFake = typeof data.probFake === 'number' ? data.probFake : 0;
            const probReal = typeof data.probReal === 'number' ? data.probReal : 0;
            const score    = probReal; // d√πng probReal l√†m "ƒë·ªô tin c·∫≠y" hi·ªÉn th·ªã d∆∞·ªõi bubble

            const probFakePct = (probFake * 100).toFixed(2);
            const probRealPct = (probReal * 100).toFixed(2);

            let msgText = '';

            if (isUrl) {
                // ===== Tr∆∞·ªùng h·ª£p URL =====
                if (verdict === 'FAKE') {
                    msgText += 'K·∫øt qu·∫£ cho ƒë∆∞·ªùng link n√†y: TIN GI·∫¢.\n';
                    msgText += '‚ö† N·ªôi dung tr√™n trang n√†y c√≥ d·∫•u hi·ªáu kh√¥ng ƒë√°ng tin c·∫≠y.\n';
                } else if (verdict === 'REAL') {
                    msgText += 'K·∫øt qu·∫£ cho ƒë∆∞·ªùng link n√†y: TIN TH·∫¨T / ƒê√ÅNG TIN C·∫¨Y.\n';
                    msgText += '‚úÖ N·ªôi dung tr√™n trang ƒë∆∞·ª£c m√¥ h√¨nh ƒë√°nh gi√° l√† c√≥ ƒë·ªô tin c·∫≠y cao.\n';
                } else {
                    msgText += `K·∫øt qu·∫£ cho ƒë∆∞·ªùng link n√†y: ${verdict || 'Kh√¥ng x√°c ƒë·ªãnh'}.\n`;
                }
            } else {
                // ===== Tr∆∞·ªùng h·ª£p TEXT =====
                if (verdict === 'FAKE') {
                    msgText += 'K·∫øt qu·∫£ cho ƒëo·∫°n vƒÉn b·∫£n n√†y: TIN GI·∫¢.\n';
                    msgText += '‚ö† N·ªôi dung c√≥ d·∫•u hi·ªáu kh√¥ng ƒë√°ng tin c·∫≠y, n√™n ki·ªÉm ch·ª©ng k·ªπ tr∆∞·ªõc khi chia s·∫ª.\n';
                } else if (verdict === 'REAL') {
                    msgText += 'K·∫øt qu·∫£ cho ƒëo·∫°n vƒÉn b·∫£n n√†y: TIN TH·∫¨T / ƒê√ÅNG TIN C·∫¨Y.\n';
                    msgText += '‚úÖ N·ªôi dung ƒë∆∞·ª£c m√¥ h√¨nh ƒë√°nh gi√° l√† kh√° ƒë√°ng tin.\n';
                } else {
                    msgText += `K·∫øt qu·∫£ cho ƒëo·∫°n vƒÉn b·∫£n n√†y: ${verdict || 'Kh√¥ng x√°c ƒë·ªãnh'}.\n`;
                }
            }

            // D√≤ng s·ªë li·ªáu chi ti·∫øt
            msgText += `‚Ä¢ X√°c su·∫•t TIN GI·∫¢ (probFake): ${probFakePct}%\n`;
            msgText += `‚Ä¢ X√°c su·∫•t TIN TH·∫¨T (probReal): ${probRealPct}%`;

            addMessage('MODEL', msgText, { verdict, score });
            statusDiv.textContent = '';

            await loadConversations(); // reload l·ªãch s·ª≠
        } catch (e) {
            console.error(e);
            addMessage(
                'MODEL',
                '‚ö† Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i sau.'
            );
            statusDiv.textContent = 'C√≥ l·ªói khi g·ªçi API ph√¢n t√≠ch.';
            showToast('L·ªói API: ' + e.message, 'error');
        } finally {
            sendBtn.disabled = false;
        }
    }


    function autoResizeTextarea() {
        messageInput.style.height = '24px';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }

    messageInput.addEventListener('input', autoResizeTextarea);

    // Enter = g·ª≠i, Shift+Enter = xu·ªëng d√≤ng
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendText();
        }
    });

    sendBtn.addEventListener('click', sendText);

    // =========================
    // G·ª¨I FILE .docx ‚Üí analyzeFileApi()
    // =========================
    attachBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', async () => {
        const file = fileInput.files[0];
        if (!file) return;

        const lower = file.name.toLowerCase();
        const allowedExtensions = ['.txt', '.doc', '.docx'];

        const isValid = allowedExtensions.some(ext => lower.endsWith(ext));
        if (!isValid) {
            showToast('Ch·ªâ cho ph√©p g·ª≠i file .txt, .doc, .docx', 'error');
            fileInput.value = '';
            return;
        }

        addMessage('USER', `ƒê√£ t·∫£i l√™n file: ${file.name}`);
        statusDiv.textContent = 'ƒêang upload & ph√¢n t√≠ch file...';

        try {
            const data = await analyzeFileApi(file);   // d√πng h√†m trong api.js

            const verdict  = data.label;
            const probFake = typeof data.probFake === 'number' ? data.probFake : 0;
            const probReal = typeof data.probReal === 'number' ? data.probReal : 0;
            const score    = probReal;

            const probFakePct = (probFake * 100).toFixed(2);
            const probRealPct = (probReal * 100).toFixed(2);

            let msgText = '';
            if (verdict === 'FAKE') {
                msgText += `K·∫øt qu·∫£ cho file "${file.name}": TIN GI·∫¢.\n`;
                msgText += '‚ö† N·ªôi dung trong file c√≥ d·∫•u hi·ªáu kh√¥ng ƒë√°ng tin c·∫≠y.\n';
            } else if (verdict === 'REAL') {
                msgText += `K·∫øt qu·∫£ cho file "${file.name}": TIN TH·∫¨T / ƒê√ÅNG TIN C·∫¨Y.\n`;
                msgText += '‚úÖ N·ªôi dung trong file ƒë∆∞·ª£c m√¥ h√¨nh ƒë√°nh gi√° l√† c√≥ ƒë·ªô tin c·∫≠y cao.\n';
            } else {
                msgText += `K·∫øt qu·∫£ cho file "${file.name}": ${verdict || 'Kh√¥ng x√°c ƒë·ªãnh'}.\n`;
            }

            msgText += `‚Ä¢ X√°c su·∫•t TIN GI·∫¢ (probFake): ${probFakePct}%\n`;
            msgText += `‚Ä¢ X√°c su·∫•t TIN TH·∫¨T (probReal): ${probRealPct}%`;

            addMessage('MODEL', msgText, { verdict, score });
            statusDiv.textContent = '';

            await loadConversations();
        } catch (e) {
            console.error(e);
            addMessage(
                'MODEL',
                '‚ö† Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß ph√¢n t√≠ch file. Vui l√≤ng th·ª≠ l·∫°i sau.'
            );
            statusDiv.textContent = 'C√≥ l·ªói khi g·ªçi API ph√¢n t√≠ch file.';
            showToast('L·ªói API: ' + e.message, 'error');
        } finally {
            fileInput.value = '';
        }
    });

    toggleLayoutBtn.addEventListener('click', () => {
        appRoot.classList.toggle('sidebar-collapsed');
    });

    // =========================
    // MODAL X√ìA "CU·ªòC H·ªòI THO·∫†I" (CH·ªà X√ìA TR√äN UI, KH√îNG X√ìA DB)
    // =========================
    function openDeleteModal(id) {
        pendingDeleteId = id;
        confirmModal.classList.add('show');
    }

    function closeDeleteModal() {
        pendingDeleteId = null;
        confirmModal.classList.remove('show');
    }

    confirmCancel.addEventListener('click', closeDeleteModal);

    confirmOk.addEventListener('click', () => {
        if (!pendingDeleteId) return;
        const id = pendingDeleteId;

        // X√≥a kh·ªèi state tr√™n UI
        conversations = conversations.filter(c => String(c.id) !== String(id));
        renderConversationList();

        if (String(conversationId) === String(id)) {
            conversationId = null;
            clearMessages();
            statusDiv.textContent = 'Cu·ªôc tr√≤ chuy·ªán m·ªõi.';
        }

        showToast('ƒê√£ x√≥a kh·ªèi danh s√°ch tr√™n tr√¨nh duy·ªát.\nD·ªØ li·ªáu g·ªëc v·∫´n c√≤n trong h·ªá th·ªëng.', 'success');
        closeDeleteModal();
    });

    // =========================
    // LOGOUT ‚Üí X√ìA SESSION TOKEN, RESET UI
    // =========================
    logoutBtn.addEventListener('click', () => {
        try {
            localStorage.removeItem('sessionToken'); // session ·∫©n danh m·ªõi
            conversations = [];
            conversationId = null;
            clearMessages();
            renderConversationList();
            statusDiv.textContent = 'ƒê√£ t·∫°o phi√™n m·ªõi (session token ƒë√£ reset).';
            showToast('ƒê√£ ƒëƒÉng xu·∫•t. B·∫Øt ƒë·∫ßu phi√™n m·ªõi.', 'success');
            window.location.reload();
        } catch (e) {
            console.error('L·ªói khi logout:', e);
            showToast('L·ªói khi ƒëƒÉng xu·∫•t: ' + e.message, 'error');
        }
    });

    // =========================
    // KH·ªûI T·∫†O BAN ƒê·∫¶U
    // =========================
    addMessage(
        'MODEL',
        'Xin ch√†o üëã. M√¨nh l√† InSight AI. H√£y d√°n ƒëo·∫°n tin / b√†i b√°o ho·∫∑c t·∫£i l√™n file Word (.docx) ƒë·ªÉ ki·ªÉm tra Fake/Real v√† xem l·∫°i l·ªãch s·ª≠ ·ªü thanh b√™n tr√°i nh√©!'
    );

    loadConversations();
</script>

</body>
</html>
